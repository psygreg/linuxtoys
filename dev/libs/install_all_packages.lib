#!/bin/bash

ROOT_DIR="$PWD"
while [[ "${ROOT_DIR##*/}" != "linuxtoys" && "$ROOT_DIR" != "/" ]]; do ROOT_DIR="${ROOT_DIR%/*}"; done
source "$ROOT_DIR/dev/libs/utils.lib"

PACKAGE_MANAGERS=("dnf" "apt" "pacman" "zypper")

for manager in "${PACKAGE_MANAGERS[@]}"; do
    if command -v "$manager" >/dev/null 2>&1; then
        PACKAGE_MANAGER="$manager"
        break
    fi
done

_msg "info" "Detected package manager: $PACKAGE_MANAGER"

# Define package lists based on distro
case $PACKAGE_MANAGER in
dnf)
    INSTALLER="sudo dnf install -y"
    PACKAGES="python3.13 python3.13-devel zenity jq gobject-introspection-devel cairo-devel cairo cairo-gobject-devel gtk3 curl wget git vte291 gcc pkg-config patchelf devscripts rpmbuild"
    ;;
apt)
    INSTALLER="sudo apt install -y"
    # Mapping Fedora names to Debian/Ubuntu names
    # python3-devel -> python3-dev
    # gobject-introspection-devel -> libgirepository1.0-dev
    # cairo-devel -> libcairo2-dev
    # cairo-gobject-devel -> (included in libcairo2-dev usually, but adding libcairo-gobject2 just in case)
    # gtk3 -> libgtk-3-dev
    # vte291 -> libvte-2.91-dev
    PACKAGES="python3.13 python3.13-dev python3.13-venv zenity jq libgirepository1.0-dev libcairo2-dev libcairo2 libcairo-gobject2 libgtk-3-dev curl wget git libvte-2.91-dev gcc pkg-config patchelf dput devscripts rpmbuild"
    ;;
pacman)
    INSTALLER="sudo pacman -S --noconfirm"
    # Arch names
    PACKAGES="python3.13 zenity jq gobject-introspection cairo gtk3 curl wget git vte3 gcc pkgconf patchelf rpmbuild"
    ;;
zypper)
    INSTALLER="sudo zypper install -y"
    PACKAGES="python3.13 python3.13-devel zenity jq gobject-introspection-devel cairo-devel cairo cairo-gobject-devel gtk3 curl wget git vte291 gcc pkg-config patchelf dput devscripts rpmbuild"
    ;;
*)
    _msg "error" "Unsupported package manager: $PACKAGE_MANAGER"
    _msg "error" "Please install the following packages manually: python3 python3-devel zenity jq gobject-introspection-devel cairo-devel cairo cairo-gobject-devel gtk3 curl wget git vte291 gcc pkg-config"
    exit 1
    ;;
esac

_msg "info" "Installer command: $INSTALLER"
_msg "info" "Packages to install: $PACKAGES"

# Install Packages
$INSTALLER $PACKAGES

# Check Exit Status
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
    if [ $EXIT_CODE -eq 1 ]; then
        _msg "error" "Installation failed with status code 1."
        _msg "error" "Possible causes:"
        _msg "error" "- Permission denied (are you sudo?)"
        _msg "error" "- Package not found (check package names for your distro)"
        _msg "error" "- Package manager lock held by another process"
        _msg "error" "- Network issues"
    else
        _msg "error" "Installation failed with status code $EXIT_CODE."
    fi
    exit $EXIT_CODE
else
    _msg "info" "All packages installed successfully!"
fi
