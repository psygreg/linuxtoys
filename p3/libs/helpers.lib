# library of helpers and repository checkers

# --- Flatpak ---

flatpak_in_lib() {
    sudo_rq
    [ -f /tmp/linuxtoys_flatpak_done ] && return 0

    # Install flatpak if missing
    if ! command -v flatpak &>/dev/null; then
        case "${ID_LIKE:-$ID}" in
            *debian*|*ubuntu*)
                sudo apt install -y flatpak || return 1 ;;
            *arch*|*archlinux*|*cachyos*)
                sudo pacman -S --noconfirm flatpak || return 1 ;;
            *suse*)
                sudo zypper in -y flatpak || return 1 ;;
            *)
                _msg error "Unsupported distribution for automatic flatpak installation"; return 1 ;;
        esac
        sleep 2
    fi

    # Add Flathub remote if not exists
    flatpak remote-add --if-not-exists --user flathub https://dl.flathub.org/repo/flathub.flatpakrepo 

    sudo flatpak remote-add --if-not-exists --system flathub https://dl.flathub.org/repo/flathub.flatpakrepo

    touch /tmp/linuxtoys_flatpak_done
    return 0
}

# --- Multilib ---

multilib_chk() {
    pacman -Slq multilib &>/dev/null && return 0;

    printf "\n[multilib]\nInclude = /etc/pacman.d/mirrorlist\n" | sudo tee -a /etc/pacman.conf >/dev/null

    if sudo pacman -Syy && pacman -Slq multilib &>/dev/null; then
        return 0
    else
        _msg error "Failed to enable multilib repository. Please check /etc/pacman.conf manually."
        return 1
    fi
}

# --- Chaotic AUR ---

chaotic_aur_lib() {
    if [[ ! "$ID" =~ ^(arch|cachyos)$ ]] && [[ ! "$ID_LIKE" =~ (arch|archlinux) ]]; then
        fatal "$msg077" # Assuming msg077 is defined elsewhere or should be replaced with text
    fi

    pacman -Slq chaotic-aur &>/dev/null && return 0
    
    # Clean previous
    sudo sed -i '/\[chaotic-aur\]/,/Include = \/etc\/pacman.d\/chaotic-mirrorlist/ d' /etc/pacman.conf

    # Keys
    if ! sudo pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com || \
       ! sudo pacman-key --lsign-key 3056513887B78AEB; then
        fatal "Failed to add keys to keyring"
    fi

    # Keyring & Mirrorlist
    if ! sudo pacman -U --noconfirm 'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst' \
         'https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst'; then
        fatal "Failed to install chaotic-keyring and chaotic-mirrorlist"
    fi

    # Enable Repo
    printf "\n[chaotic-aur]\nInclude = /etc/pacman.d/chaotic-mirrorlist\n" | sudo tee -a /etc/pacman.conf >/dev/null

    # Verify
    if sudo pacman -Syy && pacman -Slq chaotic-aur &>/dev/null; then
        zeninf "$msg024" # Assuming msg024 is defined
    else
        fatal "Failed to setup chaotic-aur on your system"
    fi
}

# --- RPMFusion ---

rpmfusion_chk() {
    local fedora_version
    if ! fedora_version=$(rpm -E %fedora 2>/dev/null) || [ "$fedora_version" = "%fedora" ]; then
        _msg error "Could not determine Fedora version"
        return 1
    fi

    local install_cmd="sudo dnf install -y"
    command -v rpm-ostree &>/dev/null && install_cmd="sudo rpm-ostree install -yA"

    # Free
    if ! rpm -qi "rpmfusion-free-release" &>/dev/null; then
        _msg info "Installing RPMFusion Free repository..."
        $install_cmd "https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-${fedora_version}.noarch.rpm" || \
            { _msg error "Failed to install RPMFusion Free repository"; return 1; }
        _msg info "RPMFusion Free repository installed successfully"
    else
        _msg info "RPMFusion Free repository is already installed"
    fi

    # Non-Free
    if ! rpm -qi "rpmfusion-nonfree-release" &>/dev/null; then
        _msg info "Installing RPMFusion Non-Free repository..."
        $install_cmd "https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-${fedora_version}.noarch.rpm" || \
            { _msg error "Failed to install RPMFusion Non-Free repository"; return 1; }
        _msg info "RPMFusion Non-Free repository installed successfully"
    else
        _msg info "RPMFusion Non-Free repository is already installed"
    fi
    return 0
}

# --- PyPI ---

pip_lib() {
    if [[ "$ID" =~ ^(arch|cachyos)$ ]] || [[ "$ID_LIKE" =~ (arch|archlinux) ]]; then
        _packages=(python-pip python-pipx)
    else
        _packages=(python3-pip pipx)
    fi 
    _install_
}

# --- CLInfo Test ---

clinfo_chk () {
    # Install clinfo if not present
    if ! command -v clinfo &>/dev/null; then
        _msg info "clinfo not found, installing..."
        sudo_rq
        
        _packages=(clinfo)
        _install_
    fi
    
    # Check if OpenCL acceleration is available
    # Parse the first line of clinfo output which shows "Number of platforms: X"
    local platform_count
    platform_count=$(clinfo 2>&1 | grep -m1 "Number of platforms" | grep -oE "[0-9]+$")
    
    if [ -n "$platform_count" ] && [ "$platform_count" -ge 1 ]; then
        _msg info "OpenCL acceleration is available ($platform_count platform(s) found)"
        return 0
    else
        _msg error "OpenCL acceleration is not available"
        return 1
    fi
}