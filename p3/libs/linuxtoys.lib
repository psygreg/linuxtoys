## linuxtoys function library
source /etc/os-release
source "$SCRIPT_DIR/libs/helpers.lib"
export SUDO_ASKPASS="$SCRIPT_DIR/libs/zpass.sh"

# --- UI & Logging ---

# Unified message handler
_msg() {
    local type="$1"
    local text="$2"
    local title="${3:-LinuxToys}"

    if [[ "$DISABLE_ZENITY" == "1" ]]; then
        echo "$text"
        return 0
    fi

    case "$type" in
        info)    zenity --info --text "$text" --width 360 --height 300 ;;
        warning) zenity --warning --text "$text" --width 360 --height 300 ;;
        error)   zenity --error --title "$title" --text "$text" --width 360 --height 300 ;;
        *)       echo "$text" ;;
    esac
}

zeninf() { _msg info "$1"; }
zenwrn() { _msg warning "$1"; }

fatal() {
    _msg error "$1" "Fatal Error"
    exit 1
}

nonfatal() {
    _msg error "$1" "Error"
    return 1
}

# --- Sudo Handling ---

sudo_rq() {
    # Check if already authorized
    if sudo -n true 2>/dev/null || [ -f /tmp/linuxtoys_sudo_validated ]; then
        [ -n "$LINUXTOYS_CHECKLIST" ] && touch /tmp/linuxtoys_sudo_validated
        return 0
    fi

    # CLI mode
    if [[ "$DISABLE_ZENITY" == "1" ]]; then
        local max_attempts=3
        local attempts=0

        while (( attempts < max_attempts )); do
            read -rsp "Password: " _pass
            echo
            if echo "${_pass}" | sudo -S -v &>/dev/null; then
                [ -n "$LINUXTOYS_CHECKLIST" ] && touch /tmp/linuxtoys_sudo_validated
                return 0
            fi
            ((attempts++))
            echo "❌ Wrong password. Attempts: ${attempts}/${max_attempts}."
        done
        fatal "❌ Wrong password or sudo failed (max attempts reached)."
    fi

    # GUI mode
    if command -v sudo-rs &>/dev/null; then
        _pass=$(zenity --password --title="LinuxToys")
        echo "${_pass}" | sudo-rs -Sv
    else
        sudo -Av
    fi

    if [ "$(sudo whoami)" = "root" ]; then
        [ -n "$LINUXTOYS_CHECKLIST" ] && touch /tmp/linuxtoys_sudo_validated
        return 0
    else
        fatal "Wrong password. Do you have sudo?"
    fi
}

# --- Package Management ---

_install_() {
    [[ -z "$_packages" ]] && return 0

    # OSTree handling
    if command -v rpm-ostree &>/dev/null; then
        local _to_install=()
        for pkg in "${_packages[@]}"; do
            rpm -qi "$pkg" &>/dev/null || _to_install+=("$pkg")
        done
        if [[ ${#_to_install[@]} -gt 0 ]]; then
            for item in "${_to_install[@]}"; do
                sudo rpm-ostree install -yA "$item"
            done
        fi
        unset _packages
        return 0
    fi

    # Standard Package Managers
    case "$ID_LIKE" in
        *debian*|*ubuntu*)
            for pak in "${_packages[@]}"; do
                dpkg -s "$pak" &>/dev/null || sudo apt install -y "$pak"
            done
            ;;
        *arch*|*archlinux*)
            for pak in "${_packages[@]}"; do
                pacman -Qi "$pak" &>/dev/null && continue
                
                if pacman -Ss "$pak" | grep -q "$pak"; then
                    sudo pacman -S --noconfirm "$pak"
                else
                    if zenity --question --title "Installer" --text "$msg305" --height=300 --width=300; then
                        if ! command -v paru &>/dev/null; then
                            if pacman -Ss paru | grep -q paru; then
                                sudo pacman -S --noconfirm paru
                            else
                                chaotic_aur_lib
                                sleep 1
                                sudo pacman -S --noconfirm paru
                            fi
                        fi
                        paru -S -a --noconfirm --skipreview "$pak"
                    else
                        return 1
                    fi
                fi
            done
            ;;
        *rhel*|*fedora*|*centos*)
             for pak in "${_packages[@]}"; do
                rpm -qi "$pak" &>/dev/null || sudo dnf in -y "$pak"
            done
            ;;
        *suse*)
            for pak in "${_packages[@]}"; do
                rpm -qi "$pak" &>/dev/null || sudo zypper in -y "$pak"
            done
            ;;
    esac
    unset _packages
}

_flatpak_() {
    [[ -z "$_flatpaks" ]] && return 0
    for flat in "${_flatpaks[@]}"; do
        flatpak install --or-update --user --noninteractive flathub "$flat"
    done
    unset _flatpaks
}

# --- Utils ---

_lang_() {
    local lang="${LANG:0:2}"
    local available=" am ar bn cs de el en es fa fi fr he hi id it ja ko ms nl pl pt ru sv sw ta th tl tr uk ur vi zh bg bs da hr hu is no sk sl sr nb az lv ga ne my sq tg uz hy ka km lo mn ro et lt "
    
    if [[ "$available" == *" $lang "* ]]; then
        langfile="$lang"
    else
        langfile="en"
    fi
}

# --- System Detection ---

is_arch() { [[ ("$ID" == "arch" || "$ID_LIKE" =~ "arch") && "$ID" != "cachyos" ]]; }
is_cachy() { [[ "$ID" == "cachyos" ]]; }
is_fedora() { [[ ("$ID" == "fedora" || "$ID" == "rhel" || "$ID_LIKE" =~ "fedora" || "$ID_LIKE" =~ "rhel" || "$ID_LIKE" =~ "centos") ]] && ! command -v rpm-ostree &>/dev/null; }
is_ostree() { [[ ("$ID" == "fedora" || "$ID" == "rhel" || "$ID_LIKE" =~ "fedora" || "$ID_LIKE" =~ "rhel" || "$ID_LIKE" =~ "centos") ]] && command -v rpm-ostree &>/dev/null; }
is_debian() { [[ "$ID" == "debian" || "$ID" == "ubuntu" || "$ID_LIKE" =~ "debian" || "$ID_LIKE" =~ "ubuntu" ]]; }
is_ubuntu() { [[ "$ID" == "ubuntu" || "$ID_LIKE" =~ "ubuntu" ]]; }
is_suse() { [[ "$ID" == "suse" || "$ID" == "opensuse" || "$ID_LIKE" =~ "suse" ]]; }
